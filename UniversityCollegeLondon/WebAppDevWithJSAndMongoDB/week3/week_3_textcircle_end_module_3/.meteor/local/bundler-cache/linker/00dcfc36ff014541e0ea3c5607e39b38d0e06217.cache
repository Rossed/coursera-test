[{"type":"js","data":"(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar global = Package.meteor.global;\nvar meteorEnv = Package.meteor.meteorEnv;\nvar _ = Package.underscore._;\nvar RoutePolicy = Package.routepolicy.RoutePolicy;\nvar WebApp = Package.webapp.WebApp;\nvar main = Package.webapp.main;\nvar WebAppInternals = Package.webapp.WebAppInternals;\nvar Symbol = Package['ecmascript-runtime'].Symbol;\nvar Map = Package['ecmascript-runtime'].Map;\nvar Set = Package['ecmascript-runtime'].Set;\nvar meteorBabelHelpers = Package['babel-runtime'].meteorBabelHelpers;\nvar Promise = Package.promise.Promise;\nvar MongoInternals = Package.mongo.MongoInternals;\nvar Mongo = Package.mongo.Mongo;\n\n/* Package-scope variables */\nvar __coffeescriptShare, ShareJS;\n\n(function(){\n\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                           //\n// packages/mizzao_sharejs/sharejs-meteor-auth.coffee.js                                                     //\n//                                                                                                           //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                             //\n__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;\nvar Fiber, Future, LogicalOps, _monkeyPatch, _submitOpMonkeyPatched, runValidations,                         // 2\n  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },\n  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };                          //\n                                                                                                             //\nFiber = Npm.require('fibers');                                                                               // 2\n                                                                                                             //\nFuture = Npm.require('fibers/future');                                                                       // 3\n                                                                                                             //\nLogicalOps = {                                                                                               // 6\n  'or': function(a, b) {                                                                                     //\n    return a || b;                                                                                           //\n  },                                                                                                         //\n  'and': function(a, b) {                                                                                    //\n    return a && b;                                                                                           //\n  }                                                                                                          //\n};                                                                                                           //\n                                                                                                             //\nrunValidations = function(currentOp, validations, doc, token) {                                              // 11\n  var k, lookIn, nestedResult, result, v;                                                                    // 12\n  if (currentOp === null) {                                                                                  //\n    if ((validations != null ? validations.or : void 0) != null) {                                           //\n      return runValidations(\"or\", validations.or, doc, token);                                               // 15\n    } else if ((validations != null ? validations.and : void 0) != null) {                                   //\n      return runValidations(\"and\", validations.and, doc, token);                                             // 18\n    } else if (validations != null) {                                                                        //\n      return runValidations(\"and\", validations, doc, token);                                                 // 21\n    } else {                                                                                                 //\n      return true;                                                                                           // 25\n    }                                                                                                        //\n  } else if (currentOp != null) {                                                                            //\n    if (currentOp === \"or\") {                                                                                //\n      result = false;                                                                                        //\n    } else if (currentOp = \"and\") {                                                                          //\n      result = true;                                                                                         //\n    }                                                                                                        //\n    for (k in validations) {                                                                                 // 32\n      v = validations[k];                                                                                    //\n      if (k === \"or\" || k === \"and\") {                                                                       //\n        nestedResult = runValidations(k, v, doc, token);                                                     //\n        result = LogicalOps[currentOp](result, nestedResult);                                                //\n      } else {                                                                                               //\n        switch (v) {                                                                                         // 38\n          case \"is_in_array\":                                                                                // 38\n            result = LogicalOps[currentOp](result, indexOf.call(doc[k], token) >= 0);                        //\n            break;                                                                                           // 39\n          case \"isnt_in_array\":                                                                              // 38\n            lookIn = doc.k || [];                                                                            //\n            result = LogicalOps[currentOp](result, indexOf.call(doc[k], token) < 0);                         //\n            break;                                                                                           // 41\n          case \"is_equal\":                                                                                   // 38\n            result = LogicalOps[currentOp](result, token === doc[k]);                                        //\n            break;                                                                                           // 44\n          case \"isnt_equal\":                                                                                 // 38\n            result = LogicalOps[currentOp](result, token === !doc[k]);                                       //\n        }                                                                                                    // 38\n      }                                                                                                      //\n    }                                                                                                        // 32\n    return result;                                                                                           // 48\n  }                                                                                                          //\n};                                                                                                           // 11\n                                                                                                             //\n_submitOpMonkeyPatched = false;                                                                              // 50\n                                                                                                             //\n_monkeyPatch = function(agent) {                                                                             // 52\n  var UserAgent, model;                                                                                      // 53\n  UserAgent = Object.getPrototypeOf(agent);                                                                  //\n  model = ShareJS.model;                                                                                     //\n  UserAgent.submitOp = function(docName, opData, callback) {                                                 //\n    var dupIfSource;                                                                                         // 58\n    opData.meta || (opData.meta = {});                                                                       //\n    opData.meta.userId = this.name;                                                                          //\n    opData.meta.source = this.sessionId;                                                                     //\n    dupIfSource = opData.dupIfSource || [];                                                                  //\n    if (opData.op) {                                                                                         //\n      return this.doAuth({                                                                                   //\n        docName: docName,                                                                                    //\n        op: opData.op,                                                                                       //\n        v: opData.v,                                                                                         //\n        meta: opData.meta,                                                                                   //\n        dupIfSource: dupIfSource                                                                             //\n      }, 'submit op', callback, (function(_this) {                                                           //\n        return function() {                                                                                  //\n          return model.applyOp(docName, opData, callback);                                                   //\n        };                                                                                                   //\n      })(this));                                                                                             //\n    } else {                                                                                                 //\n      return this.doAuth({                                                                                   //\n        docName: docName,                                                                                    //\n        meta: opData.meta                                                                                    //\n      }, 'submit meta', callback, (function(_this) {                                                         //\n        return function() {                                                                                  //\n          return model.applyMetaOp(docName, opData, callback);                                               //\n        };                                                                                                   //\n      })(this));                                                                                             //\n    }                                                                                                        //\n  };                                                                                                         //\n  console.log(\"ShareJS: patched UserAgent submitOp function to record Meteor userId\");                       //\n  return _submitOpMonkeyPatched = true;                                                                      //\n};                                                                                                           // 52\n                                                                                                             //\nthis.MeteorAccountsAuthHandler = (function() {                                                               // 75\n  function MeteorAccountsAuthHandler(options, client) {                                                      //\n    this.options = options;                                                                                  //\n    this.client = client;                                                                                    //\n    this.handle = bind(this.handle, this);                                                                   //\n  }                                                                                                          //\n                                                                                                             //\n  MeteorAccountsAuthHandler.prototype.fetchDocument = function(collection, key) {                            //\n    var future;                                                                                              // 80\n    future = new Future;                                                                                     //\n    this.client.collection(collection, function(err, collection) {                                           //\n      if (err) {                                                                                             //\n        return future[\"throw\"](err);                                                                         // 82\n      }                                                                                                      //\n      return collection.findOne({                                                                            //\n        _id: key                                                                                             //\n      }, function(err, doc) {                                                                                //\n        if (err) {                                                                                           //\n          console.warn(\"failed to get doc in \" + collection + \" with key \" + key + \": \" + err);              //\n        }                                                                                                    //\n        if (err) {                                                                                           //\n          future[\"throw\"](null);                                                                             //\n        }                                                                                                    //\n        return future[\"return\"](doc);                                                                        //\n      });                                                                                                    //\n    });                                                                                                      //\n    return future;                                                                                           // 89\n  };                                                                                                         //\n                                                                                                             //\n  MeteorAccountsAuthHandler.prototype.getAuthentication = function(agent) {                                  //\n    var collection, future, token, user, validations;                                                        // 93\n    token = agent.authentication;                                                                            //\n    validations = this.options.authenticate.token_validations;                                               //\n    collection = this.options.authenticate.collection;                                                       //\n    future = new Future;                                                                                     //\n    user = this.fetchDocument(collection, agent.authentication).wait();                                      //\n    if (!((user != null) || ((validations.or != null) && (validations.and != null)))) {                      //\n      future[\"return\"](false);                                                                               //\n    }                                                                                                        //\n    future[\"return\"](runValidations(null, validations, user, token));                                        //\n    return future;                                                                                           // 107\n  };                                                                                                         //\n                                                                                                             //\n  MeteorAccountsAuthHandler.prototype.getAuthorization = function(agent, action) {                           //\n    var collection, doc, future, token, validations;                                                         // 111\n    token = agent.authentication;                                                                            //\n    validations = this.options.authorize.token_validations;                                                  //\n    collection = this.options.authorize.collection;                                                          //\n    future = new Future;                                                                                     //\n    doc = this.fetchDocument(collection, action.docName).wait();                                             //\n    if (!((doc != null) || ((validations.or != null) && (validations.and != null)))) {                       //\n      future[\"return\"](false);                                                                               //\n    }                                                                                                        //\n    future[\"return\"](runValidations(null, validations, doc, token));                                         //\n    return future;                                                                                           // 125\n  };                                                                                                         //\n                                                                                                             //\n  MeteorAccountsAuthHandler.prototype.handle = function(agent, action) {                                     //\n    var authenticate, authorize, opsToAuthorize, ref;                                                        // 129\n    if (!_submitOpMonkeyPatched) {                                                                           //\n      _monkeyPatch(agent);                                                                                   //\n    }                                                                                                        //\n    authenticate = this.options.authenticate != null;                                                        //\n    authorize = this.options.authorize != null;                                                              //\n    opsToAuthorize = (ref = this.options.authorize) != null ? ref.apply_on : void 0;                         //\n    return (Fiber(((function(_this) {                                                                        //\n      return function() {                                                                                    //\n        var ref1, res;                                                                                       // 136\n        res = false;                                                                                         //\n        if (authenticate && (action.type === \"connect\")) {                                                   //\n          res = _this.getAuthentication(agent).wait();                                                       //\n          if (res) {                                                                                         //\n            agent.name = agent.authentication;                                                               //\n          }                                                                                                  //\n        } else if (authorize && (ref1 = action.type, indexOf.call(opsToAuthorize, ref1) >= 0)) {             //\n          res = _this.getAuthorization(agent, action).wait();                                                //\n        } else {                                                                                             //\n          res = true;                                                                                        //\n        }                                                                                                    //\n        if (res) {                                                                                           //\n          return action.accept();                                                                            //\n        } else {                                                                                             //\n          return action.reject();                                                                            //\n        }                                                                                                    //\n      };                                                                                                     //\n    })(this)))).run();                                                                                       //\n  };                                                                                                         //\n                                                                                                             //\n  return MeteorAccountsAuthHandler;                                                                          //\n                                                                                                             //\n})();                                                                                                        //\n                                                                                                             //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function(){\n\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                           //\n// packages/mizzao_sharejs/sharejs-server.coffee.js                                                          //\n//                                                                                                           //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                             //\n__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;\nvar Future, options, ref;                                                                                    // 3\n                                                                                                             //\nFuture = Npm.require('fibers/future');                                                                       // 3\n                                                                                                             //\nShareJS = ShareJS || {};                                                                                     // 5\n                                                                                                             //\noptions = _.extend({                                                                                         // 9\n  staticPath: null,                                                                                          //\n  db: {                                                                                                      //\n    type: 'mongo',                                                                                           //\n    opsCollectionPerDoc: false                                                                               //\n  }                                                                                                          //\n}, (ref = Meteor.settings.sharejs) != null ? ref.options : void 0);                                          //\n                                                                                                             //\nswitch (options.db.type) {                                                                                   // 20\n  case 'mongo':                                                                                              // 20\n                                                                                                             //\n    /*                                                                                                       // 22\n      ShareJS 0.6.3 mongo driver:                                                                            //\n      https://github.com/share/ShareJS/blob/v0.6.3/src/server/db/mongo.coffee                                //\n      It will create its own indices on the 'ops' collection.                                                //\n     */                                                                                                      //\n    options.db.client = MongoInternals.defaultRemoteCollectionDriver().mongo.db;                             //\n    options.db.client.open = function() {};                                                                  //\n    if (options.accounts_auth != null) {                                                                     //\n      options.auth = new MeteorAccountsAuthHandler(options.accounts_auth, options.db.client).handle;         //\n    }                                                                                                        //\n    break;                                                                                                   // 21\n  default:                                                                                                   // 20\n    Meteor._debug(\"ShareJS: using unsupported db type \" + options.db.type + \", falling back to in-memory.\");\n}                                                                                                            // 20\n                                                                                                             //\nRoutePolicy.declare('/channel/', 'network');                                                                 // 46\n                                                                                                             //\nNpm.require('share').server.attach(WebApp.connectHandlers, options);                                         // 49\n                                                                                                             //\n                                                                                                             //\n/*                                                                                                           // 51\n  ShareJS attaches the server API to a weird place. Oh well...                                               //\n  https://github.com/share/ShareJS/blob/v0.6.2/src/server/index.coffee                                       //\n */                                                                                                          //\n                                                                                                             //\nShareJS.model = WebApp.connectHandlers.model;                                                                // 55\n                                                                                                             //\nShareJS.initializeDoc = function(docName, content) {                                                         // 58\n  return ShareJS.model.create(docName, 'text', {}, function(err) {                                           //\n    var opData;                                                                                              // 60\n    if (err) {                                                                                               //\n      console.log(err);                                                                                      //\n      return;                                                                                                // 62\n    }                                                                                                        //\n    opData = {                                                                                               //\n      op: [                                                                                                  //\n        {                                                                                                    //\n          i: content,                                                                                        //\n          p: 0                                                                                               //\n        }                                                                                                    //\n      ],                                                                                                     //\n      v: 0,                                                                                                  //\n      meta: {}                                                                                               //\n    };                                                                                                       //\n    return ShareJS.model.applyOp(docName, opData, function(err, res) {                                       //\n      if (err) {                                                                                             //\n        return console.log(err);                                                                             //\n      }                                                                                                      //\n    });                                                                                                      //\n  });                                                                                                        //\n};                                                                                                           // 58\n                                                                                                             //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n/* Exports */\nif (typeof Package === 'undefined') Package = {};\n(function (pkg, symbols) {\n  for (var s in symbols)\n    (s in pkg) || (pkg[s] = symbols[s]);\n})(Package['mizzao:sharejs'] = {}, {\n  ShareJS: ShareJS\n});\n\n})();\n","servePath":"/packages/mizzao_sharejs.js","sourceMap":{"version":3,"sources":["/packages/mizzao_sharejs/sharejs-meteor-auth.coffee","/packages/mizzao_sharejs/sharejs-server.coffee"],"names":[],"mappings":"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","file":"/packages/mizzao_sharejs.js","sourcesContent":["# Auth API helpers\nFiber = Npm.require('fibers');\nFuture = Npm.require('fibers/future')\n\n# Metaprogramming aids\nLogicalOps =\n    'or'  : (a, b) -> a or b\n    'and' : (a, b) -> a and b\n\n# Recursively evaluate the validations provided in settings.json\nrunValidations = (currentOp, validations, doc, token) ->\n  if currentOp is null\n    if validations?.or?\n      # recurse into or\n      return runValidations(\"or\", validations.or, doc, token)\n    else if validations?.and?\n      # recurse into and\n      return runValidations(\"and\", validations.and, doc, token)\n    else if validations?\n      # If no higher level \"or\" and \"and\", default to \"and\"\n      return runValidations(\"and\", validations, doc, token)\n    else\n      # No validations being asked to run - user possibly just wants to check\n      # for presence of user/doc\n      return true\n  else if currentOp?\n    if currentOp is \"or\"\n      result = false\n    else if currentOp = \"and\"\n      result = true\n\n    for k, v of validations\n      if k in [\"or\", \"and\"]\n        # recurse into or/and\n        nestedResult = runValidations(k, v, doc, token)\n        result = LogicalOps[currentOp](result, nestedResult)\n      else\n        switch v\n          when \"is_in_array\"\n            result = LogicalOps[currentOp](result, token in doc[k])\n          when \"isnt_in_array\"\n            lookIn = doc.k or []\n            result = LogicalOps[currentOp](result, token not in doc[k])\n          when \"is_equal\"\n            result = LogicalOps[currentOp](result, token is doc[k])\n          when \"isnt_equal\"\n            result = LogicalOps[currentOp](result, token is not doc[k])\n    return result\n\n_submitOpMonkeyPatched = false\n\n_monkeyPatch = (agent) ->\n  UserAgent = Object.getPrototypeOf(agent)\n  model = ShareJS.model\n  # Overriding https://github.com/share/ShareJS/blob/v0.6.2/src/server/useragent.coffee,\n  # including variables in closure. >.< @josephg\n  UserAgent.submitOp = (docName, opData, callback) ->\n    opData.meta ||= {}\n    opData.meta.userId = @name\n    opData.meta.source = @sessionId\n    dupIfSource = opData.dupIfSource or []\n\n    # If ops and meta get coalesced, they should be separated here.\n    if opData.op\n      @doAuth {docName, op:opData.op, v:opData.v, meta:opData.meta, dupIfSource}, 'submit op', callback, =>\n        model.applyOp docName, opData, callback\n    else\n      @doAuth {docName, meta:opData.meta}, 'submit meta', callback, =>\n        model.applyMetaOp docName, opData, callback\n\n  console.log \"ShareJS: patched UserAgent submitOp function to record Meteor userId\"\n  _submitOpMonkeyPatched = true\n\n# Based on https://github.com/share/ShareJS/wiki/User-access-control\nclass @MeteorAccountsAuthHandler\n  constructor: (@options, @client) ->\n\n  # Get a future that resolves to the entry from the database for given query\n  fetchDocument: (collection, key) ->\n    future = new Future\n    @client.collection collection, (err, collection) ->\n      return future.throw(err) if err\n\n      collection.findOne {_id: key}, (err, doc) ->\n        console.warn \"failed to get doc in #{collection} with key #{key}: #{err}\" if err\n        future.throw(null) if err\n        future.return(doc)\n\n    return future\n\n  # Get a future that would resolve to authentication as a bool\n  getAuthentication: (agent) ->\n    token = agent.authentication\n    validations = @options.authenticate.token_validations\n    collection = @options.authenticate.collection\n\n    future = new Future\n\n    user = @fetchDocument(collection, agent.authentication).wait()\n    # Not having user necessitates bailing out!\n    # Having both \"and\" and \"or\" on the top level is not allowed\n    unless user? or (validations.or? and validations.and?)\n      future.return false\n\n    future.return runValidations(null, validations, user, token)\n\n    return future\n\n  # Get a future that would resolve to authorization as a bool\n  getAuthorization: (agent, action) ->\n    token = agent.authentication\n    validations = @options.authorize.token_validations\n    collection = @options.authorize.collection\n\n    future = new Future\n\n    doc = @fetchDocument(collection, action.docName).wait()\n    # Not having document necessitates bailing out!\n    # Having both \"and\" and \"or\" on the top level is not allowed\n    unless doc? or (validations.or? and validations.and?)\n      future.return false\n\n    future.return runValidations(null, validations, doc, token)\n\n    return future\n\n  handle: (agent, action) =>\n    # This is ugly, but we have no other way to store Meteor usernames in ShareJS 0.6.2\n    _monkeyPatch(agent) unless _submitOpMonkeyPatched\n\n    authenticate = @options.authenticate?\n    authorize = @options.authorize?\n    opsToAuthorize = @options.authorize?.apply_on\n\n    (Fiber (=>\n      res = false\n\n      if authenticate and (action.type is \"connect\")\n        res = @getAuthentication(agent).wait()\n        # Save Meteor userId if we successfully authenticated\n        agent.name = agent.authentication if res\n\n      else if authorize and action.type in opsToAuthorize\n        res = @getAuthorization(agent, action).wait()\n      else\n        # Accept all other actions\n        res = true\n\n      if res\n        action.accept()\n      else\n        action.reject()\n    )).run()\n","# Creates a (persistent) ShareJS server\n# Based on https://github.com/share/ShareJS/wiki/Getting-started\nFuture = Npm.require('fibers/future')\n\nShareJS = ShareJS || {}\n# See docs for options. Uses mongo by default to enable persistence.\n\n# Using special options from https://github.com/share/ShareJS/blob/master/src/server/index.coffee\noptions = _.extend {\n  staticPath: null # Meteor is serving up this application\n  # rest: null # disable REST interface?\n  db: {\n    # Default option is Mongo because Meteor provides it\n    type: 'mongo'\n    # A doc/op indexed collection keeps the namespace cleaner in a Meteor app.\n    opsCollectionPerDoc: false\n  }\n}, Meteor.settings.sharejs?.options\n\nswitch options.db.type\n  when 'mongo'\n    ###\n      ShareJS 0.6.3 mongo driver:\n      https://github.com/share/ShareJS/blob/v0.6.3/src/server/db/mongo.coffee\n      It will create its own indices on the 'ops' collection.\n    ###\n    options.db.client = MongoInternals.defaultRemoteCollectionDriver().mongo.db\n\n    # Disable the open command due to the bug introduced in ShareJS 0.6.3\n    # where an open database connection is not accepted\n    # https://github.com/share/ShareJS/commit/f98a4adeca396df3ec6b1d838b965ff158f452a3\n\n    # Meteor has already opened the database connection, so this should work,\n    # but watch monkey-patch carefully with changes in how\n    # https://github.com/meteor/meteor/blob/devel/packages/mongo-livedata/mongo_driver.js\n    # uses the API at\n    # http://mongodb.github.io/node-mongodb-native/api-generated/mongoclient.html\n    options.db.client.open = ->\n\n    if options.accounts_auth?\n      options.auth = new MeteorAccountsAuthHandler(options.accounts_auth, options.db.client).handle\n  else\n    Meteor._debug \"ShareJS: using unsupported db type \" + options.db.type + \", falling back to in-memory.\"\n\n# Declare the path that ShareJS uses to Meteor\nRoutePolicy.declare('/channel/', 'network');\n\n# Attach the sharejs REST and bcsocket interfaces as middleware to the meteor connect server\nNpm.require('share').server.attach(WebApp.connectHandlers, options);\n\n###\n  ShareJS attaches the server API to a weird place. Oh well...\n  https://github.com/share/ShareJS/blob/v0.6.2/src/server/index.coffee\n###\nShareJS.model = WebApp.connectHandlers.model\n\n# A convenience function for creating a document on the server.\nShareJS.initializeDoc = (docName, content) ->\n  ShareJS.model.create docName, 'text', {}, (err) ->\n    if err\n      console.log(err)\n      return\n    # One op; insert all the content at position 0\n    # https://github.com/share/ShareJS/wiki/Server-api\n    opData = {\n      op: [ {i: content, p: 0} ]\n      v: 0\n      meta: {}\n    }\n    ShareJS.model.applyOp docName, opData, (err, res) ->\n      console.log(err) if err\n"]}}]